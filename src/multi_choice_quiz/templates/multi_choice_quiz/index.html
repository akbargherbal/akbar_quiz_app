{% extends 'multi_choice_quiz/base.html' %}
{% load static %}

{% block title %}{% if quiz %}{{ quiz.title }} | {% endif %}Quiz App{% endblock %}

{% block extra_js_head %}
<script src="{% static 'multi_choice_quiz/app.js' %}"></script>
<link rel="stylesheet" href="{% static 'multi_choice_quiz/style.css' %}">

<script id="quiz-data" type="application/json">
  {% autoescape off %}
  {{ quiz_data }}
  {% endautoescape %}
</script>
{% endblock %}

{% block content %}
<div
    id="quiz-app-container"
    class="max-w-2xl mx-auto w-11/12 px-4 py-5 sm:px-6 md:py-8 flex-grow flex flex-col justify-start"
    x-data="quizApp()"
    x-init="init()"
    x-cloak
    {% if quiz_id %}data-quiz-id="{{ quiz_id }}"{% endif %}
>

  <!-- Quiz Question Section -->
  <template x-if="!quizCompleted">
    <div>
      <!-- Progress Bar, Stars, Counter, Home Button -->
      <div class="sticky top-0 z-10 bg-slate-900 py-4 flex items-center relative min-h-[40px] gap-3" id="status-bar">
        <!-- Progress Bar -->
        <div class="flex justify-center items-center flex-grow flex-basis-0 min-w-[50px]">
            <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden shadow-inner">
                <div
                    class="h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full transition-all duration-400 ease-in-out shadow-[0_0_8px_rgba(124,58,237,0.5)]"
                    :style="`width: ${Math.max(5, (currentQuestionIndex / Math.max(1, questions.length -1)) * 100)}%`"
                    x-transition:style
                ></div>
            </div>
        </div>
        <!-- Star Rating -->
        <div class="text-yellow-400 leading-none flex-shrink-0 whitespace-nowrap"
             x-html="starRatingDisplay"
             title="Your performance rating">
        </div>
        <!-- Question Counter -->
        <div
            class="bg-slate-800 text-gray-200 rounded-full px-3 py-1 md:px-4 font-bold font-mono flex-shrink-0"
            x-text="questions.length > 0 ? `${currentQuestionIndex + 1}/${questions.length}` : '0/0'"
        ></div>
        <!-- Home Button -->
        <div class="w-10 h-10 md:w-12 md:h-12 bg-slate-800 rounded-full flex items-center justify-center cursor-pointer transition duration-200 text-gray-200 shadow-md hover:bg-slate-700 hover:scale-105 ml-auto flex-shrink-0">
            <a href="{% url 'pages:home' %}" class="text-gray-200 no-underline flex items-center justify-center w-full h-full">
                <span>üè†</span>
            </a>
        </div>
      </div>

      <!-- Question Text Container -->
      <div
        class="sticky top-0 z-8 bg-slate-800/80 rounded-2xl p-2 sm:p-6 md:p-8 relative mt-px mb-4 sm:mb-6 backdrop-blur-sm border border-slate-700 shadow-lg flex items-center justify-center"
        x-show="!quizCompleted && currentQuestion"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95"
      >
              <div class="text-center leading-normal text-gray-200" id="question-text">
                   <div x-html="currentQuestion.text"></div>
          </div>
      </div>

      <!-- Options Container -->
      <div
          class="flex flex-col gap-3 sm:gap-4"
          x-show="!quizCompleted && currentQuestion"
          x-transition:enter="transition ease-out duration-300 delay-100"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
      >
        <template
          x-for="(option, index) in currentQuestion.options"
          :key="index"
        >
          <button
            class="option-button"
            :class="getOptionClass(index)"
            @click="selectOption(index)"
            :disabled="isAnswered"
            x-html="option"
          >
             <!-- Option content is set by x-html -->
          </button>
        </template>

      </div>
    </div>
  </template>


  <!-- Results Panel -->
  <template x-if="quizCompleted">
    <div
        id="quiz-results-panel"
        class="bg-slate-800 rounded-2xl p-5 md:p-7 lg:p-8 text-gray-300 my-5 mx-auto border border-slate-700 shadow-lg w-full"
        x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
    >
      {# <<< START ADDITION: Display Quiz Title in Results >>> #}
      {% if quiz %} {# Check if quiz object exists in context #}
      <h2 class="text-xl md:text-2xl font-semibold text-center text-purple-300 mb-2">{{ quiz.title }}</h2>
      <hr class="border-slate-600 mb-5"> {# Optional separator #}
      {% endif %}
      {# <<< END ADDITION >>> #}

      <h3 class="text-gray-200 text-2xl md:text-3xl lg:text-4xl text-center mt-0 mb-6 font-bold">Quiz Results</h3>

      <!-- Results Content (Stats and Mistakes) -->
      <div class="md:flex md:gap-8">
          <!-- Stats Section -->
          <div class="pb-5 border-b border-slate-700 mb-5 md:border-b-0 md:border-r md:pr-6 md:pb-0 md:mb-0 md:w-48 md:flex-shrink-0">
            <div class="flex flex-wrap justify-around gap-y-4 md:flex-col md:items-start md:gap-y-5">
              <!-- Rating -->
              <div class="flex flex-col items-center text-center w-1/2 md:w-full md:items-start md:text-left">
                  <span class="text-gray-400 text-sm mb-1">Rating</span>
                  <span class="text-yellow-400 text-2xl md:text-2xl leading-none" x-html="starRatingDisplay"></span>
              </div>
              <!-- Score -->
              <div class="flex flex-col items-center text-center w-1/2 md:w-full md:items-start md:text-left">
                  <span class="text-gray-400 text-sm mb-1">Score</span>
                  <span class="text-gray-200 text-xl md:text-2xl font-semibold"><span class="text-purple-400" x-text="score"></span> / <span x-text="questions.length"></span></span>
              </div>
              <!-- Percentage -->
              <div class="flex flex-col items-center text-center w-1/2 md:w-full md:items-start md:text-left">
                  <span class="text-gray-400 text-sm mb-1">Percentage</span>
                  <span class="text-purple-400 text-xl md:text-2xl font-semibold" x-text="calculatePercentage() + '%'"></span>
              </div>
              <!-- Time -->
              <div class="flex flex-col items-center text-center w-1/2 md:w-full md:items-start md:text-left">
                  <span class="text-gray-400 text-sm mb-1">Time</span>
                  <span class="text-gray-200 text-xl md:text-2xl font-semibold" x-text="formatTime(quizTime)"></span>
              </div>
            </div>
          </div>

          <!-- Mistakes Review Section -->
          <div class="mt-5 md:mt-0 md:flex-grow min-w-0">
            <h4 class="text-lg text-center text-gray-200 mb-4 pb-2 border-b border-dashed border-slate-600 md:text-left">Mistakes Review</h4>
            <ul class="mistakes-review-list list-none p-0 m-0 max-h-60 md:max-h-72 lg:max-h-80 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-700">
                <!-- No mistakes message -->
                <template x-if="questions.length === 0">
                     <li class="text-center text-gray-400 py-4">No questions were loaded for this quiz.</li>
                </template>
                <!-- Perfect score message -->
                <template x-if="score === questions.length && questions.length > 0">
                     <li class="text-center text-gray-400 py-4">üéâ No mistakes! Well done!</li>
                </template>
                <!-- Loop through mistakes -->
                <template x-for="(question, index) in questions" :key="index">
                  <template x-if="userAnswers[index] !== question.answerIndex">
                    <li class="flex items-start mb-4 pb-2.5 md:mb-5 md:pb-3.5 border-b border-slate-700 last:border-b-0 last:mb-0">
                      <span class="text-red-600 mr-2.5 md:mr-3 text-lg md:text-xl flex-shrink-0 mt-0.5">‚ùå</span>
                      <div class="mistake-content-wrapper flex-1 min-w-0 break-words" data-testid="mistake-item-content">
                        <div class="font-medium text-gray-200 mb-1 leading-snug text-sm md:text-base">
                           <div x-html="`Q${index + 1}. ${question.text}`"></div>
                        </div>
                        <div class="text-gray-400 text-xs md:text-sm">
                          <strong class="!text-green-600 font-semibold">Correct:</strong>
                          <span x-html="question.options[question.answerIndex]"></span>
                        </div>
                      </div>
                    </li>
                  </template>
                </template>
            </ul>
          </div>
      </div>

      <!-- Action Buttons -->
      <div class="mt-6 flex flex-col sm:flex-row justify-center sm:justify-end gap-3 pt-4 border-t border-slate-700">
        <a href="{% url 'pages:home' %}" class="py-2.5 px-5 rounded-lg text-base font-bold cursor-pointer text-center transition duration-200 shadow-md no-underline w-full sm:w-auto bg-slate-600 text-gray-200 border-none hover:bg-slate-700 hover:-translate-y-0.5 hover:shadow-lg">
          Go Home
        </a>
        <button class="py-2.5 px-5 rounded-lg text-base font-bold cursor-pointer text-center transition duration-200 shadow-md no-underline w-full sm:w-auto bg-purple-600 text-white border-none hover:bg-purple-700 hover:-translate-y-0.5 hover:shadow-lg" @click="restartQuiz">
          Play Again
        </button>
      </div>
    </div>
  </template>
</div>
{% endblock %}