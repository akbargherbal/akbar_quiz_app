{% extends 'multi_choice_quiz/base.html' %}
{% load static %}

{% block title %}Quiz App{% endblock %}

{% block extra_js_head %}
    {# Load your app logic BEFORE Alpine initializes #}
    <script src="{% static 'multi_choice_quiz/app.js' %}"></script>
    
    {# Embed the quiz data safely as JSON, accessible via ID #}
    <script id="quiz-data" type="application/json">
        {% autoescape off %}
        {{ quiz_data }}
        {% endautoescape %}
    </script>
{% endblock %}

{% block content %}
<div class="quiz-container" x-data="quizApp()" x-init="init()">
    <!-- Quiz Active State -->
    <template x-if="!quizCompleted">
        <div>
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="quiz-progress">
                    {# Ensure questions array exists before iterating #}
                    <template x-if="questions.length > 0">
                        <template x-for="(question, index) in questions" :key="index">
                            <div class="progress-dot" :class="{ 'active': index === currentQuestionIndex }"></div>
                        </template>
                    </template>
                </div>
                <!-- You can add functionality to the home icon if needed -->
                <div class="home-icon">üè†</div>
            </div>

            <!-- Question Card -->
            {# Only show if not completed AND currentQuestion is available #}
            <div class="question-card" x-show="!quizCompleted && currentQuestion">
                <div class="progress-indicator" x-text="`${currentQuestionIndex + 1}/${questions.length}`"></div>
                <div class="question-text" x-text="currentQuestion.text"></div>
            </div>

            <!-- Options -->
            {# Only show if not completed AND currentQuestion is available #}
            <div class="options-container" x-show="!quizCompleted && currentQuestion">
                <template x-for="(option, index) in currentQuestion.options" :key="index">
                    <button
                        class="option-button"
                        :class="getOptionClass(index)"
                        x-text="option"
                        @click="selectOption(index)"
                        :disabled="isAnswered">
                    </button>
                </template>
            </div>
        </div>
    </template>

    <!-- Quiz Completed State -->
    <template x-if="quizCompleted">
        <div class="results-card">
            <h2 class="results-title">Quiz Completed!</h2>
            <p class="results-score">Your Score: <span x-text="score"></span> out of <span x-text="questions.length"></span></p>
            <div class="results-summary">
                <template x-for="(question, index) in questions" :key="index">
                    <div class="result-item">
                        <span class="result-icon" x-html="userAnswers[index] === question.answerIndex ? '‚úÖ' : '‚ùå'"></span>
                            <span x-text="`${index + 1}. ${question.text}`"></span>
                            <template x-if="userAnswers[index] !== question.answerIndex">
                            <span class="correct-answer-info">(Correct: <span x-text="question.options[question.answerIndex]"></span>)</span>
                            </template>
                    </div>
                </template>
            </div>
            <button class="restart-button" @click="restartQuiz">Play Again?</button>
        </div>
    </template>

    <!-- Modal Dialog for Feedback -->
    {# Only show modal if currentQuestion exists #}
    <template x-if="currentQuestion">
        <div class="modal-overlay" x-show="showModal" x-transition>
            <div class="modal-container"
                    :class="{ 'modal-correct': isCorrect, 'modal-incorrect': !isCorrect }"
                    @click.away="showModal = false" x-show="showModal" x-transition.scale.origin.center>
                <div class="modal-icon" x-html="isCorrect ? '‚úî' : '‚úò'"></div>
                <div class="modal-message" x-text="isCorrect ? 'Correct!' : 'Incorrect!'"></div>
                <div class="modal-explanation" x-show="!isCorrect" x-text="`The correct answer was: ${currentQuestion.options[currentQuestion.answerIndex]}`"></div>
                <button class="modal-button" @click="nextQuestion">Continue</button>
            </div>
        </div>
    </template>

</div> <!-- End of quiz-container -->
{% endblock %}